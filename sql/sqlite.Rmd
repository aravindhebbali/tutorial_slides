---
output: _output.yaml
---

## {data-background="database.png"}

## Agenda

<hr>

## Libraries

<hr>

```{r lite1, eval=FALSE}
library(dbplyr)
library(dplyr)
library(DBI)
library(RSQLite)
```

```{r liteload, echo=FALSE, eval=TRUE, results='hide', message=FALSE}
library(dbplyr)
library(dplyr)
library(DBI)
library(RSQLite)
```

## Data

<hr>

We will use a database that contains the ecommerce data we have used in the previous modules. You can download the 
database from [here](https://github.com/rsquaredacademy/dbplyr_tutorial).

```{r import, eval=FALSE}
ecom <- read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
```


```{r show, echo=FALSE, eval=TRUE, message=FALSE}
ecom <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
ecom
```


## Data Dictionary

<hr>

Below is the description of the data set:

- id: row id
- referrer: referrer website/search engine
- os: operating system
- browser: browser
- device: device used to visit the website
- n_pages: number of pages visited
- duration: time spent on the website (in seconds)
- repeat: frequency of visits
- country: country of origin
- purchase: whether visitor purchased
- order_value: order value of visitor (in dollars)


## {data-background="connect.png"}

## Connect

<hr>

```{r lite2}
con <- DBI::dbConnect(RSQLite::SQLite(), 
                      dbname = "mydatabase.db")
```

## Connection Summary

<hr>

```{r lite3}
summary(con)
```

## List Tables

<hr>

```{r lite6}
dbListTables(con)
```

## List Fields

<hr>

```{r lite7}
DBI::dbListFields(con, "ecom")
```

## {data-background="query_data.png"}

## Querying Data

<hr>

- `dbReadTable()`: read entire table
- `dbGetQuery()`: read few rows
- `dbSendQuery()` & `dbFetch()`: read data in batches

## Entire Table

<hr>

```{r lite8}
DBI::dbReadTable(con, 'ecom')
```

## Few Rows

<hr>

```{r lite9}
DBI::dbGetQuery(con, "select * from ecom limit 10")
```

## Read Data in Batches

<hr>

```{r lite10}
query <- DBI::dbSendQuery(con, 'select * from ecom')
result <- DBI::dbFetch(query, n = 30)
result
```

## Query Status

<hr>

```{r lite11}
DBI::dbHasCompleted(query)
```

## Query Info

<hr>

```{r lite12}
DBI::dbGetInfo(query)
```

## Latest Query

<hr>

```{r lite13}
DBI::dbGetStatement(query)
```

## Rows Fetched

<hr>

```{r lite14}
DBI::dbGetRowCount(query)
```

## Rows Affected

<hr>

```{r lite15}
DBI::dbGetRowsAffected(query)
```

## Column Info

<hr>

```{r lite16}
DBI::dbColumnInfo(query)
```

## Clear Results

<hr>

```{r lite17}
DBI::dbClearResult(query)
```

## {data-background="create_table.png"}

## Create Table

<hr>

```{r lite18} 
x <- 1:10
y <- letters[1:10]
trial <- tibble::tibble(x, y)
DBI::dbWriteTable(con, "trial", trial)
```

## check if table is created in database

<hr>

```{r lite19}
DBI::dbListTables(con)
DBI::dbExistsTable(con, "trial")
```

## query sample data from table

<hr>

```{r lite20}
DBI::dbGetQuery(con, "select * from trial limit 5")
```

## overwrite table in the database

<hr>

```{r lite21}
x <- sample(100, 10)
y <- letters[11:20]
trial2 <- tibble::tibble(x, y)
DBI::dbWriteTable(con, "trial", trial2, overwrite = TRUE)
```

## query sample data from table to see if it has been overwritten

<hr>

```{r lite22}
DBI::dbGetQuery(con, "select * from trial limit 5")
```

## append data to the table in the database

<hr>

```{r lite23}
x <- sample(100, 10)
y <- letters[5:14]
trial3 <- tibble::tibble(x, y)
DBI::dbWriteTable(con, "trial", trial3, append = TRUE)
```

## query sample data from table to see if new data is appended

<hr>

```{r lite24}
DBI::dbReadTable(con, "trial")
```

## Insert Rows

<hr>

```{r lite25}
DBI::dbExecute(con,
  "INSERT into trial (x, y) VALUES (32, 'c'), (45, 'k'), (61, 'h')"
)
```

## Insert Rows

<hr>

```{r lite26}
DBI::dbSendStatement(con,
  "INSERT into trial (x, y) VALUES (25, 'm'), (54, 'l'), (16, 'y')"
)
```


## SQLite data type

<hr>

```{r lite27}
DBI::dbDataType(RSQLite::SQLite(), "a")
DBI::dbDataType(RSQLite::SQLite(), 1:5)
DBI::dbDataType(RSQLite::SQLite(), 1.5)
```

## remove table from database

<hr>

```{r lite28}
DBI::dbRemoveTable(con, "trial")
```

## check if table has been removed 

<hr> 

```{r lite29}
DBI::dbListTables(con)
```

## Generate SQL Query

<hr>

```{r lite31}
DBI::sqlCreateTable(con, "new", c(x = "integer", y = "text"))
```


## Data

<hr>

```{r lite34, eval=FALSE}
ecom <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
```

```{r lite33, echo=FALSE, eval=TRUE, message=FALSE}
ecom <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
ecom
```

## Append Table

<hr>

```{r lite32}
DBI::sqlAppendTable(con, "ecom", head(ecom))
```

## Close Database Connection

<hr>

```{r lite30}
DBI::dbDisconnect(con)
```

## {data-background="thankyou.png"}

<!-- To do: -->
<!--   - add agenda -->
<!--   - add introduction -->