---
title: "Quick Guide: R & SQLite"
output: 
  revealjs::revealjs_presentation:
    transition: slide
    incremental: true
    theme: moon
    highlight: monochrome
    center: true
    fig_width: 6
    fig_height: 5
    reveal_options:
      slideNumber: true
      previewLinks: true
---

## Introduction

## Libraries

```{r lite1, echo=FALSE, eval=TRUE, results='hide', message=FALSE}
library(dbplyr)
library(dplyr)
library(DBI)
library(RSQLite)
```

## Data

We will use a database that contains the ecommerce data we have used in the previous modules. You can download the 
database from [here](https://github.com/rsquaredacademy/dbplyr_tutorial).


## connect to database

```{r lite2}
con <- DBI::dbConnect(RSQLite::SQLite(), 
                      dbname = "J:/gist/dbplyr_tutorial/mydatabase.db")
```

## connection summary

```{r lite3}
summary(con)
```



## get info about tables in database


## list tables in mydatabase.db

```{r lite6}
dbListTables(con)
```

## list fields in a table

```{r lite7}
DBI::dbListFields(con, "ecom")
```

## query data

## read entire table

```{r lite8}
DBI::dbReadTable(con, 'ecom')
```

## read a few lines from the table

```{r lite9}
DBI::dbGetQuery(con, "select * from ecom limit 10")
```

## read data in batches

```{r lite10}
query <- DBI::dbSendQuery(con, 'select * from ecom')
result <- DBI::dbFetch(query, n = 30)
```

## check if the above operations have been completed

```{r lite11}
DBI::dbHasCompleted(query)
```

## query 

## query information

```{r lite12}
DBI::dbGetInfo(query)
```

## latest query executed

```{r lite13}
DBI::dbGetStatement(query)
```

## number of rows fetched from database

```{r lite14}
DBI::dbGetRowCount(query)
```

## number of rows affected in the database

```{r lite15}
DBI::dbGetRowsAffected(query)
```

## column info of table in query

```{r lite16}
DBI::dbColumnInfo(query)
```

## resources

## clear all results from previous queries

```{r lite17}
DBI::dbClearResult(query)
```

## write table to database

## create table in the database    

```{r lite18} 
x <- 1:10
y <- letters[1:10]
trial <- tibble::tibble(x, y)
DBI::dbWriteTable(con, "trial", trial)
```

## check if table is created in database

```{r lite19}
DBI::dbListTables(con)
DBI::dbExistsTable(con, "trial")
```

## query sample data from table

```{r lite20}
DBI::dbGetQuery(con, "select * from trial limit 5")
```

## overwrite table in the database

```{r lite21}
x <- sample(100, 10)
y <- letters[11:20]
trial2 <- tibble::tibble(x, y)
DBI::dbWriteTable(con, "trial", trial2, overwrite = TRUE)
```

## query sample data from table to see if it has been overwritten

```{r lite22}
DBI::dbGetQuery(con, "select * from trial limit 5")
```

## append data to the table in the database

```{r lite23}
x <- sample(100, 10)
y <- letters[5:14]
trial3 <- tibble::tibble(x, y)
DBI::dbWriteTable(con, "trial", trial3, append = TRUE)
```

## query sample data from table to see if new data is appended

```{r lite24}
DBI::dbReadTable(con, "trial")
```

## insert rows into trial table

## dbExecute returns the number of rows affected after the operation

```{r lite25}
DBI::dbExecute(con,
  "INSERT into trial (x, y) VALUES (32, 'c'), (45, 'k'), (61, 'h')"
)
```

## use dbSendStatement

```{r lite26}
DBI::dbSendStatement(con,
  "INSERT into trial (x, y) VALUES (25, 'm'), (54, 'l'), (16, 'y')"
)
```

## data types

## SQLite data type

```{r lite27}
DBI::dbDataType(RSQLite::SQLite(), "a")
DBI::dbDataType(RSQLite::SQLite(), 1:5)
DBI::dbDataType(RSQLite::SQLite(), 1.5)
```

## remove table from database

```{r lite28}
DBI::dbRemoveTable(con, "trial")
```

## check if table has been removed 

```{r lite29}
DBI::dbListTables(con)
```

## sql queries

## create table

```{r lite31}
DBI::sqlCreateTable(con, "new", c(x = "integer", y = "text"))
```

## append table

## import ecommerce data from github

```{r lite33, echo=FALSE, message=FALSE, results='hide'}
ecom <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
```

----

```{r lite32}
DBI::sqlAppendTable(con, "ecom", head(ecom))
```

## close connection to database

```{r lite30}
DBI::dbDisconnect(con)
```