---
output: _output.yaml
---

## {data-background="database.png"}

## Agenda

<hr>

- connect to databases from R
- display database information
- list tables 
- create table
- read data into R
- export data to database
- remove tables
- query data using dplyr
- disconnect from database

## Libraries

<hr>

```{r lite1, eval=FALSE}
library(DBI)
library(dbplyr)
library(dplyr)
```

```{r liteload, echo=FALSE, eval=TRUE, results='hide', message=FALSE}
library(dbplyr)
library(dplyr)
library(DBI)
library(RSQLite)
```

## Data

<hr>

```{r import, eval=FALSE}
ecom <- read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
```

```{r show, echo=FALSE, eval=TRUE, message=FALSE}
ecom <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
ecom
```


## Data Dictionary

<hr>

- id: row id
- referrer: referrer website/search engine
- os: operating system
- browser: browser
- device: device used to visit the website
- n_pages: number of pages visited
- duration: time spent on the website (in seconds)
- repeat: frequency of visits
- country: country of origin
- purchase: whether visitor purchased
- order_value: order value of visitor (in dollars)


## {data-background="connect.png"}

## Connect

<hr>

```{r lite2}
con <- DBI::dbConnect(RSQLite::SQLite(), 
                      dbname = "mydatabase.db")
```

## Connection Summary

<hr>

```{r lite3}
summary(con)
```

## List Tables

<hr>

```{r lite6}
dbListTables(con)
```

## List Fields

<hr>

```{r lite7}
DBI::dbListFields(con, "ecom")
```

## {data-background="query_data.png"}

## Querying Data

<hr>

- read entire table
- read few rows
- read data in batches

## Entire Table

<hr>

```{r lite8}
DBI::dbReadTable(con, 'ecom')
```

## Few Rows

<hr>

```{r lite9}
DBI::dbGetQuery(con, "select * from ecom limit 10")
```

## Read Data in Batches

<hr>

```{r lite10}
query  <- DBI::dbSendQuery(con, 'select * from ecom')
result <- DBI::dbFetch(query, n = 30)
result
```

## Query Status

<hr>

```{r lite11}
DBI::dbHasCompleted(query)
```

## Query Info

<hr>

```{r lite12}
DBI::dbGetInfo(query)
```

## Latest Query

<hr>

```{r lite13}
DBI::dbGetStatement(query)
```

## Rows Fetched

<hr>

```{r lite14}
DBI::dbGetRowCount(query)
```

## Rows Affected

<hr>

```{r lite15}
DBI::dbGetRowsAffected(query)
```

## Column Info

<hr>

```{r lite16}
DBI::dbColumnInfo(query)
```

## Clear Results

<hr>

```{r lite17}
DBI::dbClearResult(query)
```

## {data-background="create_table.png"}

## Create Table

<hr>

```{r lite18} 
# sample data
x     <- 1:10
y     <- letters[1:10]
trial <- tibble::tibble(x, y)

# write table to database
DBI::dbWriteTable(con, "trial", trial)
```

## List Tables

<hr>

```{r lite19}
DBI::dbListTables(con)
DBI::dbExistsTable(con, "trial")
```

## Query Data

<hr>

```{r lite20}
DBI::dbGetQuery(con, "select * from trial limit 5")
```

## Overwrite Table

<hr>

```{r lite21}
# sample data
x      <- sample(100, 10)
y      <- letters[11:20]
trial2 <- tibble::tibble(x, y)

# overwrite table trial
DBI::dbWriteTable(con, "trial", trial2, overwrite = TRUE)
```

## Query Data

<hr>

Let us check if `trial` table has been overwritten by querying data.

```{r lite22}
DBI::dbGetQuery(con, "select * from trial limit 5")
```

## Append Data

<hr>

```{r lite23}
# sample data
x      <- sample(100, 10)
y      <- letters[5:14]
trial3 <- tibble::tibble(x, y)

# append data
DBI::dbWriteTable(con, "trial", trial3, append = TRUE)
```

## Query Data

<hr>

Let us check if data has been appended by querying data.

```{r lite24}
DBI::dbReadTable(con, "trial")
```

## Insert Rows

<hr>

```{r lite25}
DBI::dbExecute(con,
  "INSERT into trial (x, y) VALUES (32, 'c'), (45, 'k'), (61, 'h')"
)
```

## Insert Rows

<hr>

```{r lite26}
DBI::dbSendStatement(con,
  "INSERT into trial (x, y) VALUES (25, 'm'), (54, 'l'), (16, 'y')"
)
```

## Data Type

<hr>

```{r lite27}
DBI::dbDataType(RSQLite::SQLite(), "a")
DBI::dbDataType(RSQLite::SQLite(), 1:5)
DBI::dbDataType(RSQLite::SQLite(), 1.5)
```

## Remove Table

<hr>

```{r lite28}
DBI::dbRemoveTable(con, "trial")
```

## List Tables

<hr> 

Let us check if `trial` table has been removed from the database by listing all the tables.

```{r lite29}
DBI::dbListTables(con)
```

## Generate SQL Query

<hr>

```{r lite31}
DBI::sqlCreateTable(con, "new", c(x = "integer", y = "text"))
```


## Data

<hr>

Let us use the first 5 rows of the `ecom` table as sample data and append it to the `ecom` table
itself.

```{r lite34, eval=FALSE}
ecom <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
```

```{r lite33, echo=FALSE, eval=TRUE, message=FALSE}
ecom <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
ecom
```

## Append Table

<hr>

```{r lite32}
DBI::sqlAppendTable(con, "ecom", head(ecom))
```

## {data-background="dbplyr.png"}


```{r dbply2, echo=FALSE}
copy_to(con, mtcars)
```

## Reference Data

<hr>

```{r dbply3}
mtcars2 <- tbl(con, "mtcars")
mtcars2
```

## Query Data

<hr>

```{r dbply4}
mtcars2 %>%
  select(mpg, cyl, drat)
```

## Query Data

<hr>

```{r dbply5}
mtcars2 %>%
  filter(mpg > 25)
```

## Query Data

<hr>

```{r dbply6}
mtcars2 %>%
  group_by(cyl) %>%
  summarise(mileage = mean(mpg))
```

## Display Query

<hr>

```{r dbply7}
mileages <- 
  mtcars2 %>%
  group_by(cyl) %>%
  summarise(mileage = mean(mpg))

show_query(mileages)
```

## Collect Data

<hr>

```{r dbply9}
collect(mileages)
```

## Close Connection

<hr>

```{r lite30}
DBI::dbDisconnect(con)
```

## {data-background="thankyou.png"}

